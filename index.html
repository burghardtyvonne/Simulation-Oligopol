<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Oligopol-Simulation – Benzinmarkt</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #ffffff;
      padding: 20px 24px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    h1 {
      margin-top: 0;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    label {
      font-size: 0.9rem;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }
    input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      margin-right: 8px;
      margin-top: 4px;
    }
    button.primary {
      background: #2563eb;
      color: white;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .section-title {
      margin-top: 20px;
      margin-bottom: 8px;
      font-size: 1.05rem;
      font-weight: 700;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
    }
    th:first-child, td:first-child {
      text-align: left;
    }
    .tagline {
      font-size: 0.9rem;
      color: #4b5563;
      margin-bottom: 4px;
    }
    .hint {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 4px;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #eff6ff;
      color: #1d4ed8;
      margin-left: 4px;
    }
    .round-indicator {
      font-size: 0.95rem;
      color: #374151;
      margin-bottom: 12px;
    }
    .history-container {
      margin-top: 16px;
      border-top: 2px solid #e5e7eb;
      padding-top: 8px;
    }
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.8rem;
      margin-bottom: 6px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 999px;
    }
    canvas {
      border: 1px solid #e5e7eb;
      margin-bottom: 8px;
      background: #f9fafb;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Oligopol-Simulation: Benzinmarkt</h1>
    <p class="tagline">
      Gib die Preise der Schülergruppen ein – die Anwendung berechnet automatisch
      den Durchschnittspreis und die neuen Marktanteile. Gewinne berechnet ihr selbst.
    </p>
    <p class="round-indicator">
      Aktuelle Runde: <span id="round-number">1</span>
      <span class="badge">Mehrere Runden möglich</span>
    </p>

    <div class="section-title">1. Marktanteile zu Beginn dieser Runde</div>
    <div class="grid" id="shares-grid"></div>
    <p class="hint">
      Diese Werte sind die Marktanteile <strong>zu Beginn der Runde</strong>.
      Mit „Neue Marktanteile übernehmen“ übernimmst du die Ergebnisse der letzten Runde.
    </p>

    <div class="section-title">2. Preise der Unternehmen in dieser Runde</div>
    <div class="grid" id="prices-grid"></div>
    <p class="hint">
      Preisgrenzen: <strong>1,60 € bis 1,90 €</strong>. Eingaben außerhalb dieses Bereichs
      werden nicht akzeptiert.
    </p>

    <button class="primary" id="run-btn">Simulation für diese Runde starten</button>
    <button class="secondary" id="apply-btn" disabled>
      Neue Marktanteile für nächste Runde übernehmen
    </button>

    <div id="results" style="display:none;">
      <div class="section-title">3. Ergebnis dieser Runde</div>
      <p><strong>Durchschnittspreis:</strong> <span id="avg-price"></span> €</p>

      <h3 class="section-title">Marktanteilsänderungen</h3>
      <table>
        <thead>
          <tr>
            <th>Unternehmen</th>
            <th>Preis (€)</th>
            <th>Abstand zum Durchschnitt (Cent)</th>
            <th>Änderung (Prozentpunkte)</th>
          </tr>
        </thead>
        <tbody id="changes-body"></tbody>
      </table>

      <h3 class="section-title">Neue Marktanteile und Absatzmengen</h3>
      <table>
        <thead>
          <tr>
            <th>Unternehmen</th>
            <th>Marktanteil alt (%)</th>
            <th>Marktanteil neu (%)</th>
            <th>Absatzmenge neu (Liter)</th>
          </tr>
        </thead>
        <tbody id="shares-body"></tbody>
      </table>
    </div>

    <div id="history" class="history-container" style="display:none;">
      <div class="section-title">4. Verlauf der Marktanteile (Grafik)</div>
      <div class="legend" id="legend"></div>
      <canvas id="historyChart" width="900" height="300"></canvas>

      <div class="section-title">5. Verlauf der Preise (Grafik)</div>
      <canvas id="priceChart" width="900" height="300"></canvas>

      <p class="hint">
        Oben: Entwicklung der Marktanteile. Unten: Entwicklung der Preise je Unternehmen über die Runden.
      </p>
    </div>
  </div>

  <script>
    // Konfiguration
    const PRICE_MIN = 1.60;
    const PRICE_MAX = 1.90;
    const LITERS_PER_PERCENT = 10000;

    // Firmen und Start-Marktanteile
    const firms = [
      { key: "aral",  name: "Aral",  startShare: 21, color: "#1d4ed8" },
      { key: "shell", name: "Shell", startShare: 20, color: "#dc2626" },
      { key: "jet",   name: "Jet",   startShare: 10.5, color: "#16a34a" },
      { key: "total", name: "Total", startShare: 9.5, color: "#f97316" },
      { key: "esso",  name: "Esso",  startShare: 7, color: "#9333ea" }
    ];

    let lastNewShares = null;
    let roundNumber = 1;

    // Verlauf: pro Runde Marktanteile und Preise
    // roundsHistory[i] = { round, shares: {aral: ..}, prices: {aral: ..} }
    const roundsHistory = [];

    function parseNumber(value) {
      if (!value) return NaN;
      return parseFloat(value.toString().replace(",", "."));
    }

    function initInputs() {
      const sharesGrid = document.getElementById("shares-grid");
      const pricesGrid = document.getElementById("prices-grid");
      sharesGrid.innerHTML = "";
      pricesGrid.innerHTML = "";

      firms.forEach(firm => {
        // Marktanteile-Eingabe
        const shareWrapper = document.createElement("div");
        const shareLabel = document.createElement("label");
        shareLabel.textContent = firm.name + " Marktanteil (%)";
        const shareInput = document.createElement("input");
        shareInput.type = "text";
        shareInput.value = firm.startShare.toString().replace(".", ",");
        shareInput.id = "share-" + firm.key;
        shareWrapper.appendChild(shareLabel);
        shareWrapper.appendChild(shareInput);
        sharesGrid.appendChild(shareWrapper);

        // Preis-Eingabe
        const priceWrapper = document.createElement("div");
        const priceLabel = document.createElement("label");
        priceLabel.textContent = firm.name + " Preis (€)";
        const priceInput = document.createElement("input");
        priceInput.type = "text";
        priceInput.id = "price-" + firm.key;
        priceInput.placeholder = "z.B. 1,75";
        priceWrapper.appendChild(priceLabel);
        priceWrapper.appendChild(priceInput);
        pricesGrid.appendChild(priceWrapper);
      });

      document.getElementById("round-number").textContent = roundNumber.toString();
      initLegend();
    }

    function initLegend() {
      const legend = document.getElementById("legend");
      legend.innerHTML = "";
      firms.forEach(firm => {
        const item = document.createElement("div");
        item.className = "legend-item";
        const colorBox = document.createElement("div");
        colorBox.className = "legend-color";
        colorBox.style.backgroundColor = firm.color;
        const label = document.createElement("span");
        label.textContent = firm.name;
        item.appendChild(colorBox);
        item.appendChild(label);
        legend.appendChild(item);
      });
    }

    function runSimulation() {
      const prices = {};
      const shares = {};
      let valid = true;
      let priceError = false;

      firms.forEach(firm => {
        const priceVal = document.getElementById("price-" + firm.key).value;
        const shareVal = document.getElementById("share-" + firm.key).value;

        const p = parseNumber(priceVal);
        const s = parseNumber(shareVal);

        if (isNaN(p) || p <= 0) valid = false;
        if (isNaN(s) || s < 0) valid = false;

        // Preisgrenzen prüfen
        if (!isNaN(p) && (p < PRICE_MIN || p > PRICE_MAX)) {
          priceError = true;
        }

        prices[firm.key] = p;
        shares[firm.key] = s;
      });

      if (!valid) {
        alert("Bitte alle Preise und Marktanteile als gültige Zahlen eingeben.");
        return;
      }

      if (priceError) {
        alert(
          "Mindestens ein Preis liegt außerhalb der erlaubten Spanne von " +
          PRICE_MIN.toFixed(2).replace(".", ",") + " € bis " +
          PRICE_MAX.toFixed(2).replace(".", ",") + " €."
        );
        return;
      }

      // Durchschnittspreis
      const avg =
        Object.values(prices).reduce((sum, val) => sum + val, 0) / firms.length;

      // Marktanteilsänderung abhängig vom Preisabstand
      function change(price) {
        const diffCents = (avg - price) * 100; // in Cent
        if (diffCents >= 6) return 3;
        if (diffCents >= 3) return 2;
        if (diffCents >= 1) return 1;
        if (diffCents >= -2) return -1;
        if (diffCents >= -5) return -2;
        return -3;
      }

      const changes = {};
      const newShares = {};

      firms.forEach(firm => {
        const p = prices[firm.key];
        const oldShare = shares[firm.key];
        const delta = change(p);
        const newShare = oldShare + delta;
        const boundedShare = Math.max(0, Math.min(40, newShare));
        changes[firm.key] = {
          price: p,
          diffCents: (avg - p) * 100,
          delta: delta
        };
        newShares[firm.key] = boundedShare;
      });

      lastNewShares = newShares;
      document.getElementById("apply-btn").disabled = false;

      // Ergebnisse anzeigen
      document.getElementById("avg-price").textContent =
        avg.toFixed(3).replace(".", ",");

      const changesBody = document.getElementById("changes-body");
      const sharesBody = document.getElementById("shares-body");
      changesBody.innerHTML = "";
      sharesBody.innerHTML = "";

      firms.forEach(firm => {
        const c = changes[firm.key];

        // Tabelle: Marktanteilsänderungen
        const trC = document.createElement("tr");
        const tdNameC = document.createElement("td");
        tdNameC.textContent = firm.name;
        const tdPrice = document.createElement("td");
        tdPrice.textContent = prices[firm.key].toFixed(3).replace(".", ",");
        const tdDiff = document.createElement("td");
        tdDiff.textContent = c.diffCents.toFixed(1).replace(".", ",");
        const tdDelta = document.createElement("td");
        tdDelta.textContent = (c.delta > 0 ? "+" : "") + c.delta.toString();

        trC.appendChild(tdNameC);
        trC.appendChild(tdPrice);
        trC.appendChild(tdDiff);
        trC.appendChild(tdDelta);
        changesBody.appendChild(trC);

        // Tabelle: neue Marktanteile & Absatzmengen
        const trS = document.createElement("tr");
        const tdNameS = document.createElement("td");
        tdNameS.textContent = firm.name;

        const tdOldShare = document.createElement("td");
        tdOldShare.textContent = shares[firm.key].toFixed(1).replace(".", ",");

        const tdNewShare = document.createElement("td");
        tdNewShare.textContent = newShares[firm.key].toFixed(1).replace(".", ",");

        const tdLiters = document.createElement("td");
        const liters = newShares[firm.key] * LITERS_PER_PERCENT;
        tdLiters.textContent = Math.round(liters).toLocaleString("de-DE");

        trS.appendChild(tdNameS);
        trS.appendChild(tdOldShare);
        trS.appendChild(tdNewShare);
        trS.appendChild(tdLiters);
        sharesBody.appendChild(trS);
      });

      document.getElementById("results").style.display = "block";

      // Verlauf speichern
      const roundEntry = { round: roundNumber, shares: {}, prices: {} };
      firms.forEach(firm => {
        roundEntry.shares[firm.key] = newShares[firm.key];
        roundEntry.prices[firm.key] = prices[firm.key];
      });
      roundsHistory.push(roundEntry);
      renderHistory();
    }

    function applyNewShares() {
      if (!lastNewShares) {
        alert("Bitte zuerst eine Runde simulieren.");
        return;
      }
      firms.forEach(firm => {
        const input = document.getElementById("share-" + firm.key);
        input.value = lastNewShares[firm.key].toString().replace(".", ",");
      });
      roundNumber += 1;
      document.getElementById("round-number").textContent =
        roundNumber.toString();
      document.getElementById("apply-btn").disabled = true;
    }

    function renderHistory() {
      const historyDiv = document.getElementById("history");
      const sharesCanvas = document.getElementById("historyChart");
      const pricesCanvas = document.getElementById("priceChart");
      const sharesCtx = sharesCanvas.getContext("2d");
      const pricesCtx = pricesCanvas.getContext("2d");

      if (roundsHistory.length === 0) {
        historyDiv.style.display = "none";
        return;
      }
      historyDiv.style.display = "block";

      // Gemeinsame Hilfen
      const margin = { left: 50, right: 20, top: 20, bottom: 40 };

      const rounds = roundsHistory.map(r => r.round);
      const maxRound = Math.max(...rounds);
      const minRound = Math.min(...rounds);

      function xPosForRound(round, width) {
        const plotWidth = width - margin.left - margin.right;
        const denom = Math.max(1, maxRound - minRound);
        return margin.left + (round - minRound) / denom * plotWidth;
      }

      // ---- Diagramm Marktanteile ----
      {
        const width = sharesCanvas.width;
        const height = sharesCanvas.height;
        sharesCtx.clearRect(0, 0, width, height);
        const plotWidth = width - margin.left - margin.right;
        const plotHeight = height - margin.top - margin.bottom;

        const yMin = 0;
        const yMax = 40;

        function yPosForShare(share) {
          return margin.top + plotHeight - (share - yMin) / (yMax - yMin) * plotHeight;
        }

        // Achsen
        sharesCtx.strokeStyle = "#9ca3af";
        sharesCtx.lineWidth = 1;
        sharesCtx.beginPath();
        sharesCtx.moveTo(margin.left, margin.top);
        sharesCtx.lineTo(margin.left, margin.top + plotHeight);
        sharesCtx.lineTo(margin.left + plotWidth, margin.top + plotHeight);
        sharesCtx.stroke();

        sharesCtx.fillStyle = "#374151";
        sharesCtx.font = "10px system-ui";

        // y-Ticks
        for (let y = 0; y <= yMax; y += 10) {
          const yPos = yPosForShare(y);
          sharesCtx.beginPath();
          sharesCtx.moveTo(margin.left - 4, yPos);
          sharesCtx.lineTo(margin.left, yPos);
          sharesCtx.stroke();
          sharesCtx.fillText(y.toString(), 10, yPos + 3);
        }

        // x-Ticks (Runden)
        for (let r = minRound; r <= maxRound; r++) {
          const xPos = xPosForRound(r, width);
          sharesCtx.beginPath();
          sharesCtx.moveTo(xPos, margin.top + plotHeight);
          sharesCtx.lineTo(xPos, margin.top + plotHeight + 4);
          sharesCtx.stroke();
          sharesCtx.fillText("R" + r, xPos - 8, margin.top + plotHeight + 16);
        }

        // Linien & Punkte pro Firma
        firms.forEach(firm => {
          // Linie
          sharesCtx.beginPath();
          let hasPoint = false;
          sharesCtx.strokeStyle = firm.color;
          sharesCtx.lineWidth = 2;

          roundsHistory.forEach(entry => {
            const r = entry.round;
            const share = entry.shares[firm.key];
            if (share === undefined) return;
            const x = xPosForRound(r, width);
            const y = yPosForShare(share);
            if (!hasPoint) {
              sharesCtx.moveTo(x, y);
              hasPoint = true;
            } else {
              sharesCtx.lineTo(x, y);
            }
          });

          if (hasPoint && roundsHistory.length > 1) {
            sharesCtx.stroke();
          }

          // Punkte
          sharesCtx.fillStyle = firm.color;
          roundsHistory.forEach(entry => {
            const r = entry.round;
            const share = entry.shares[firm.key];
            if (share === undefined) return;
            const x = xPosForRound(r, width);
            const y = yPosForShare(share);
            sharesCtx.beginPath();
            sharesCtx.arc(x, y, 4, 0, 2 * Math.PI);
            sharesCtx.fill();
          });
        });
      }

      // ---- Diagramm Preise ----
      {
        const width = pricesCanvas.width;
        const height = pricesCanvas.height;
        pricesCtx.clearRect(0, 0, width, height);
        const plotWidth = width - margin.left - margin.right;
        const plotHeight = height - margin.top - margin.bottom;

        const yMin = PRICE_MIN - 0.02;
        const yMax = PRICE_MAX + 0.02;

        function yPosForPrice(price) {
          return margin.top + plotHeight - (price - yMin) / (yMax - yMin) * plotHeight;
        }

        // Achsen
        pricesCtx.strokeStyle = "#9ca3af";
        pricesCtx.lineWidth = 1;
        pricesCtx.beginPath();
        pricesCtx.moveTo(margin.left, margin.top);
        pricesCtx.lineTo(margin.left, margin.top + plotHeight);
        pricesCtx.lineTo(margin.left + plotWidth, margin.top + plotHeight);
        pricesCtx.stroke();

        pricesCtx.fillStyle = "#374151";
        pricesCtx.font = "10px system-ui";

        // y-Ticks (Preise z.B. in 0,05-Schritten)
        const step = 0.05;
        for (let p = Math.ceil(yMin / step) * step; p <= yMax; p += step) {
          const yPos = yPosForPrice(p);
          pricesCtx.beginPath();
          pricesCtx.moveTo(margin.left - 4, yPos);
          pricesCtx.lineTo(margin.left, yPos);
          pricesCtx.stroke();
          pricesCtx.fillText(p.toFixed(2).replace(".", ","), 5, yPos + 3);
        }

        // x-Ticks (Runden)
        for (let r = minRound; r <= maxRound; r++) {
          const xPos = xPosForRound(r, width);
          pricesCtx.beginPath();
          pricesCtx.moveTo(xPos, margin.top + plotHeight);
          pricesCtx.lineTo(xPos, margin.top + plotHeight + 4);
          pricesCtx.stroke();
          pricesCtx.fillText("R" + r, xPos - 8, margin.top + plotHeight + 16);
        }

        // Linien & Punkte pro Firma
        firms.forEach(firm => {
          pricesCtx.beginPath();
          let hasPoint = false;
          pricesCtx.strokeStyle = firm.color;
          pricesCtx.lineWidth = 2;

          roundsHistory.forEach(entry => {
            const r = entry.round;
            const price = entry.prices[firm.key];
            if (price === undefined) return;
            const x = xPosForRound(r, width);
            const y = yPosForPrice(price);
            if (!hasPoint) {
              pricesCtx.moveTo(x, y);
              hasPoint = true;
            } else {
              pricesCtx.lineTo(x, y);
            }
          });

          if (hasPoint && roundsHistory.length > 1) {
            pricesCtx.stroke();
          }

          // Punkte
          pricesCtx.fillStyle = firm.color;
          roundsHistory.forEach(entry => {
            const r = entry.round;
            const price = entry.prices[firm.key];
            if (price === undefined) return;
            const x = xPosForRound(r, width);
            const y = yPosForPrice(price);
            pricesCtx.beginPath();
            pricesCtx.arc(x, y, 4, 0, 2 * Math.PI);
            pricesCtx.fill();
          });
        });
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      initInputs();
      document.getElementById("run-btn").addEventListener("click", runSimulation);
      document.getElementById("apply-btn").addEventListener("click", applyNewShares);
    });
  </script>
</body>
</html>
