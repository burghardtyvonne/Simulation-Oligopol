<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Oligopol-Simulation – Benzinmarkt</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #ffffff;
      padding: 20px 24px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    h1 {
      margin-top: 0;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    label {
      font-size: 0.9rem;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }
    input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      margin-right: 8px;
      margin-top: 4px;
    }
    button.primary {
      background: #2563eb;
      color: white;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .section-title {
      margin-top: 20px;
      margin-bottom: 8px;
      font-size: 1.05rem;
      font-weight: 700;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
    }
    th:first-child, td:first-child {
      text-align: left;
    }
    .tagline {
      font-size: 0.9rem;
      color: #4b5563;
      margin-bottom: 4px;
    }
    .hint {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 4px;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #eff6ff;
      color: #1d4ed8;
      margin-left: 4px;
    }
    .round-indicator {
      font-size: 0.95rem;
      color: #374151;
      margin-bottom: 12px;
    }
    .history-container {
      margin-top: 16px;
      border-top: 2px solid #e5e7eb;
      padding-top: 8px;
    }
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.8rem;
      margin-bottom: 6px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 999px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Oligopol-Simulation: Benzinmarkt</h1>
    <p class="tagline">
      Gib die Preise der Schülergruppen ein – die Anwendung berechnet automatisch
      den Durchschnittspreis, Marktanteilsänderungen und Gewinne.
    </p>
    <p class="round-indicator">
      Aktuelle Runde: <span id="round-number">1</span>
      <span class="badge">Mehrere Runden möglich</span>
    </p>

    <div class="section-title">1. Marktanteile zu Beginn dieser Runde</div>
    <div class="grid" id="shares-grid"></div>
    <p class="hint">
      Diese Werte sind die Marktanteile <strong>zu Beginn der Runde</strong>.
      Mit „Neue Marktanteile übernehmen“ übernimmst du die Ergebnisse der letzten Runde.
    </p>

    <div class="section-title">2. Preise der Unternehmen in dieser Runde</div>
    <div class="grid" id="prices-grid"></div>
    <p class="hint">
      Preisgrenzen: <strong>1,60 € bis 1,90 €</strong>. Eingaben außerhalb dieses Bereichs
      werden nicht akzeptiert.
    </p>

    <button class="primary" id="run-btn">Simulation für diese Runde starten</button>
    <button class="secondary" id="apply-btn" disabled>Neue Marktanteile für nächste Runde übernehmen</button>

    <div id="results" style="display:none;">
      <div class="section-title">3. Ergebnis dieser Runde</div>
      <p><strong>Durchschnittspreis:</strong> <span id="avg-price"></span> €</p>

      <h3 class="section-title">Marktanteilsänderungen</h3>
      <table>
        <thead>
          <tr>
            <th>Unternehmen</th>
            <th>Preis (€)</th>
            <th>Abstand zum Durchschnitt (Cent)</th>
            <th>Änderung (Prozentpunkte)</th>
          </tr>
        </thead>
        <tbody id="changes-body"></tbody>
      </table>

      <h3 class="section-title">Neue Marktanteile und Gewinne in dieser Runde</h3>
      <table>
        <thead>
          <tr>
            <th>Unternehmen</th>
            <th>Marktanteil alt (%)</th>
            <th>Marktanteil neu (%)</th>
            <th>Gewinn/Liter (€)</th>
            <th>Gewinn gesamt (€)</th>
          </tr>
        </thead>
        <tbody id="shares-body"></tbody>
      </table>
    </div>

    <div id="history" class="history-container" style="display:none;">
      <div class="section-title">4. Verlauf der Marktanteile (Grafik)</div>
      <div class="legend" id="legend"></div>
      <canvas id="historyChart" width="900" height="350"></canvas>
      <p class="hint">
        Die Linien zeigen, wie sich die Marktanteile der Unternehmen über die Runden entwickeln.
      </p>
    </div>
  </div>

  <script>
    // Konfiguration
    const PRICE_MIN = 1.60;
    const PRICE_MAX = 1.90;
    const costPerLiter = 1.60;

    // Firmen und Start-Marktanteile
    const firms = [
      { key: "aral",  name: "Aral",  startShare: 21, color: "#1d4ed8" },
      { key: "shell", name: "Shell", startShare: 20, color: "#dc2626" },
      { key: "jet",   name: "Jet",   startShare: 10.5, color: "#16a34a" },
      { key: "total", name: "Total", startShare: 9.5, color: "#f97316" },
      { key: "esso",  name: "Esso",  startShare: 7, color: "#9333ea" }
    ];

    let lastNewShares = null;
    let roundNumber = 1;
    // history: [{ round: 1, shares: { aral: 20, shell: 19, ... } }, ...]
    const roundsHistory = [];

    function parseNumber(value) {
      if (!value) return NaN;
      return parseFloat(value.toString().replace(",", "."));
    }

    function initInputs() {
      const sharesGrid = document.getElementById("shares-grid");
      const pricesGrid = document.getElementById("prices-grid");
      sharesGrid.innerHTML = "";
      pricesGrid.innerHTML = "";

      firms.forEach(firm => {
        // Marktanteile-Eingabe
        const shareWrapper = document.createElement("div");
        const shareLabel = document.createElement("label");
        shareLabel.textContent = firm.name + " Marktanteil (%)";
        const shareInput = document.createElement("input");
        shareInput.type = "text";
        shareInput.value = firm.startShare.toString().replace(".", ",");
        shareInput.id = "share-" + firm.key;
        shareWrapper.appendChild(shareLabel);
        shareWrapper.appendChild(shareInput);
        sharesGrid.appendChild(shareWrapper);

        // Preis-Eingabe
        const priceWrapper = document.createElement("div");
        const priceLabel = document.createElement("label");
        priceLabel.textContent = firm.name + " Preis (€)";
        const priceInput = document.createElement("input");
        priceInput.type = "text";
        priceInput.id = "price-" + firm.key;
        priceInput.placeholder = "z.B. 1,75";
        priceWrapper.appendChild(priceLabel);
        priceWrapper.appendChild(priceInput);
        pricesGrid.appendChild(priceWrapper);
      });

      document.getElementById("round-number").textContent = roundNumber.toString();
      initLegend();
    }

    function initLegend() {
      const legend = document.getElementById("legend");
      legend.innerHTML = "";
      firms.forEach(firm => {
        const item = document.createElement("div");
        item.className = "legend-item";
        const colorBox = document.createElement("div");
        colorBox.className = "legend-color";
        colorBox.style.backgroundColor = firm.color;
        const label = document.createElement("span");
        label.textContent = firm.name;
        item.appendChild(colorBox);
        item.appendChild(label);
        legend.appendChild(item);
      });
    }

    function runSimulation() {
      const prices = {};
      const shares = {};
      let valid = true;
      let priceError = false;

      firms.forEach(firm => {
        const priceVal = document.getElementById("price-" + firm.key).value;
        const shareVal = document.getElementById("share-" + firm.key).value;

        const p = parseNumber(priceVal);
        const s = parseNumber(shareVal);

        if (isNaN(p) || p <= 0) valid = false;
        if (isNaN(s) || s < 0) valid = false;

        // Preisgrenzen prüfen
        if (!isNaN(p) && (p < PRICE_MIN || p > PRICE_MAX)) {
          priceError = true;
        }

        prices[firm.key] = p;
        shares[firm.key] = s;
      });

      if (!valid) {
        alert("Bitte alle Preise und Marktanteile als gültige Zahlen eingeben.");
        return;
      }

      if (priceError) {
        alert("Mindestens ein Preis liegt außerhalb der erlaubten Spanne von "
          + PRICE_MIN.toFixed(2).replace(".", ",") + " € bis "
          + PRICE_MAX.toFixed(2).replace(".", ",") + " €.");
        return;
      }

      // Durchschnittspreis
      const avg =
        Object.values(prices).reduce((sum, val) => sum + val, 0) / firms.length;

      // Funktion für Marktanteilsänderung auf Basis des Preisabstands
      function change(price) {
        const diffCents = (avg - price) * 100; // in Cent
        if (diffCents >= 6) return 3;
        if (diffCents >= 3) return 2;
        if (diffCents >= 1) return 1;
        if (diffCents >= -2) return -1;
        if (diffCents >= -5) return -2;
        return -3;
      }

      const changes = {};
      const newShares = {};
      const profits = {};

      firms.forEach(firm => {
        const p = prices[firm.key];
        const oldShare = shares[firm.key];
        const delta = change(p);
        const newShare = oldShare + delta;

        const boundedShare = Math.max(0, Math.min(40, newShare));
        const gainPerLiter = p - costPerLiter;
        const litersSold = boundedShare * 10000;
        const profit = gainPerLiter * litersSold;

        changes[firm.key] = {
          price: p,
          diffCents: (avg - p) * 100,
          delta: delta
        };
        newShares[firm.key] = boundedShare;
        profits[firm.key] = profit;
      });

      lastNewShares = newShares;
      document.getElementById("apply-btn").disabled = false;

      // Ergebnisse anzeigen
      document.getElementById("avg-price").textContent = avg.toFixed(3).replace(".", ",");

      const changesBody = document.getElementById("changes-body");
      const sharesBody = document.getElementById("shares-body");
      changesBody.innerHTML = "";
      sharesBody.innerHTML = "";

      firms.forEach(firm => {
        const c = changes[firm.key];

        // Zeile Marktanteilsänderung
        const trC = document.createElement("tr");
        const tdNameC = document.createElement("td");
        tdNameC.textContent = firm.name;
        const tdPrice = document.createElement("td");
        tdPrice.textContent = prices[firm.key].toFixed(3).replace(".", ",");
        const tdDiff = document.createElement("td");
        tdDiff.textContent = c.diffCents.toFixed(1).replace(".", ",");
        const tdDelta = document.createElement("td");
        tdDelta.textContent = (c.delta > 0 ? "+" : "") + c.delta.toString();

        trC.appendChild(tdNameC);
        trC.appendChild(tdPrice);
        trC.appendChild(tdDiff);
        trC.appendChild(tdDelta);
        changesBody.appendChild(trC);

        // Zeile neue Marktanteile & Gewinne
        const trS = document.createElement("tr");
        const tdNameS = document.createElement("td");
        tdNameS.textContent = firm.name;

        const tdOldShare = document.createElement("td");
        tdOldShare.textContent = shares[firm.key].toFixed(1).replace(".", ",");

        const tdNewShare = document.createElement("td");
        tdNewShare.textContent = newShares[firm.key].toFixed(1).replace(".", ",");

        const gainPerLiter = prices[firm.key] - costPerLiter;
        const tdGainPerLiter = document.createElement("td");
        tdGainPerLiter.textContent = gainPerLiter.toFixed(3).replace(".", ",");

        const tdProfit = document.createElement("td");
        tdProfit.textContent = Math.round(profits[firm.key]).toLocaleString("de-DE");

        trS.appendChild(tdNameS);
        trS.appendChild(tdOldShare);
        trS.appendChild(tdNewShare);
        trS.appendChild(tdGainPerLiter);
        trS.appendChild(tdProfit);
        sharesBody.appendChild(trS);
      });

      document.getElementById("results").style.display = "block";

      // Verlauf speichern
      const roundEntry = { round: roundNumber, shares: {} };
      firms.forEach(firm => {
        roundEntry.shares[firm.key] = newShares[firm.key];
      });
      roundsHistory.push(roundEntry);
      renderHistory();
    }

    function applyNewShares() {
      if (!lastNewShares) return;
      firms.forEach(firm => {
        const input = document.getElementById("share-" + firm.key);
        input.value = lastNewShares[firm.key].toString().replace(".", ",");
      });
      roundNumber += 1;
      document.getElementById("round-number").textContent = roundNumber.toString();
      document.getElementById("apply-btn").disabled = true;
    }

    function renderHistory() {
      const historyDiv = document.getElementById("history");
      const canvas = document.getElementById("historyChart");
      const ctx = canvas.getContext("2d");

      if (roundsHistory.length === 0) {
        historyDiv.style.display = "none";
        return;
      }
      historyDiv.style.display = "block";

      const width = canvas.width;
      const height = canvas.height;
      ctx.clearRect(0, 0, width, height);

      const margin = { left: 50, right: 20, top: 20, bottom: 40 };
      const plotWidth = width - margin.left - margin.right;
      const plotHeight = height - margin.top - margin.bottom;

      const rounds = roundsHistory.map(r => r.round);
      const maxRound = Math.max(...rounds);
      const minRound = Math.min(...rounds);

      // y-Skala: Marktanteile
      const yMin = 0;
      const yMax = 40; // Obergrenze wie im Modell

      // Achsen zeichnen
      ctx.strokeStyle = "#9ca3af";
      ctx.lineWidth = 1;
      ctx.beginPath();
      // y-Achse
      ctx.moveTo(margin.left, margin.top);
      ctx.lineTo(margin.left, margin.top + plotHeight);
      // x-Achse
      ctx.lineTo(margin.left + plotWidth, margin.top + plotHeight);
      ctx.stroke();

      ctx.fillStyle = "#374151";
      ctx.font = "10px system-ui";

      // y-Skala beschriften (alle 10 %-Punkte)
      for (let y = 0; y <= yMax; y += 10) {
        const yPos = margin.top + plotHeight - (y - yMin) / (yMax - yMin) * plotHeight;
        ctx.beginPath();
        ctx.moveTo(margin.left - 4, yPos);
        ctx.lineTo(margin.left, yPos);
        ctx.stroke();
        ctx.fillText(y.toString(), 10, yPos + 3);
      }

      // x-Skala (Runden)
      for (let r = minRound; r <= maxRound; r++) {
        const xPos = margin.left + (r - minRound) / Math.max(1, (maxRound - minRound)) * plotWidth;
        ctx.beginPath();
        ctx.moveTo(xPos, margin.top + plotHeight);
        ctx.lineTo(xPos, margin.top + plotHeight + 4);
        ctx.stroke();
        ctx.fillText("R" + r, xPos - 8, margin.top + plotHeight + 16);
      }

      // Linien je Firma zeichnen
      firms.forEach(firm => {
        ctx.beginPath();
        let firstPoint = true;
        ctx.strokeStyle = firm.color;
        ctx.lineWidth = 2;

        roundsHistory.forEach(entry => {
          const r = entry.round;
          const share = entry.shares[firm.key];
          if (share === undefined) return;
          const xPos = margin.left + (r - minRound) / Math.max(1, (maxRound - minRound)) * plotWidth;
          const yPos = margin.top + plotHeight - (share - yMin) / (yMax - yMin) * plotHeight;
          if (firstPoint) {
            ctx.moveTo(xPos, yPos);
            firstPoint = false;
          } else {
            ctx.lineTo(xPos, yPos);
          }
        });

        ctx.stroke();
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      initInputs();
      document.getElementById("run-btn").addEventListener("click", runSimulation);
      document.getElementById("apply-btn").addEventListener("click", applyNewShares);
    });
  </script>
</body>
</html>
